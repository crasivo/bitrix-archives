name: Manual publish

on:
  workflow_dispatch:
    inputs:
      distro_code:
        description: 'Distribution'
        required: true
        default: 'start'
        type: choice
        options: [start,standard,business,small_business,business_cluster,business_cluster_postgresql,bitrix24,bitrix24_shop,bitrix24_enterprise]

jobs:
  publish_distro:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run
        id: analysis
        run: |
          ./bin/download-distro.sh ${{ github.event.inputs.distro_code }}
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: env.BITRIX_MAIN_VERSION != 'null'
        with:
          tag_name: ${{ github.event.inputs.distro_code }}-${{ env.BITRIX_MAIN_VERSION }}
          name: "${{ github.event.inputs.distro_code }} v${{ env.BITRIX_MAIN_VERSION }}"
          body: |
            ### Manual publish

            **General info:**
            - Distro code: `${{ github.event.inputs.distro_code }}`
            - Distro type: `${{ github.event.inputs.distro_type }}`
            - Main version: `${{ env.BITRIX_MAIN_VERSION }}`
            - Main version date: `${{ env.BITRIX_MAIN_VERSION_DATE }}`

            All files are downloaded from the official 1C-Bitrix website.
          files: |
            ${{ env.BITRIX_MANIFEST_FILEPATH }}
            ${{ env.BITRIX_META_ZIP_FILEPATH }}
            ${{ env.BITRIX_META_ZIP_FILEPATH }}.md5
            ${{ env.BITRIX_META_ZIP_FILEPATH }}.sha1
            ${{ env.BITRIX_META_ZIP_FILEPATH }}.sha256
            ${{ env.BITRIX_META_TAR_FILEPATH }}
            ${{ env.BITRIX_META_TAR_FILEPATH }}.md5
            ${{ env.BITRIX_META_TAR_FILEPATH }}.sha1
            ${{ env.BITRIX_META_TAR_FILEPATH }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
