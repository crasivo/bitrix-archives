name: Scheduled publish all distros

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual maintenance'

jobs:
  publish_distro:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        distro: [
          start,
          standard,
          bitrix24,
          bitrix24_shop,
          bitrix24_enterprise,
          small_business,
          business,
          business_cluster,
          business_cluster_postgresql
        ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Define default variables
        run: |
          echo "BITRIX_RELEASE_TAG=${{ matrix.distro }}-$(date +'%Y%m%d')" >> $GITHUB_ENV;
          echo "BITRIX_SM_VERSION=null" >> $GITHUB_ENV;
          echo "BITRIX_SM_VERSION_DATE=null" >> $GITHUB_ENV;
          echo "SKIP_PUBLISH=false" >> $GITHUB_ENV;

      - name: Download distros & create manifest
        id: analysis
        run: |
          chmod +x ./bin/download-distro.sh
          ./bin/download-distro.sh ${{ matrix.distro }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: env.SKIP_PUBLISH != 'true' && env.BITRIX_SM_VERSION != '' && env.BITRIX_SM_VERSION != 'null'
        with:
          tag_name: ${{ env.BITRIX_RELEASE_TAG }}
          name: "Distro: ${{ matrix.distro }} v${{ env.BITRIX_SM_VERSION }}"
          body: |
            ## üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–ª–∏–∑–µ

            –î–∞–Ω–Ω—ã–π —Ä–µ–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∞—Ä—Ö–∏–≤—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ü–∏–∏ `${{ matrix.distro }}` 1C-Bitrix,
            –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ 1–°-–ë–∏—Ç—Ä–∏–∫—Å.

            **Kernel (main):**
            - Version: `${{ env.BITRIX_SM_VERSION }}`
            - Release date: `${{ env.BITRIX_SM_VERSION_DATE }}`

            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ä–µ–ª–∏–∑—É –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —Ñ–∞–π–ª–µ `manifest.json`.

            ---
            –û–ø–∏—Å–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–∏ —á–µ—Ä–µ–∑ GitHub Action.
          files: |
            ${{ env.BITRIX_MANIFEST_PATH }}
            ${{ env.BITRIX_ZIP_PATH }}
            ${{ env.BITRIX_ZIP_PATH }}.*
            ${{ env.BITRIX_TAR_PATH }}
            ${{ env.BITRIX_TAR_PATH }}.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
