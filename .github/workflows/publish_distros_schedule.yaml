name: Scheduled Publish

on:
  schedule:
    - cron: '0 3 * * *' # 03:00 UTC
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual maintenance'
      notify_telegram:
        description: 'Send Telegram notifications'
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish_distro:
    name: Publish ${{ matrix.distro }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    strategy:
      fail-fast: false
      matrix:
        distro: [
          start,
          standard,
          bitrix24,
          bitrix24_shop,
          bitrix24_enterprise,
          small_business,
          business,
          business_cluster,
          business_cluster_postgresql
        ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # –í–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–≥–∞–º–∏

      - name: Download distro & create manifest
        id: download_distro
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_on: error
          command: |
            chmod +x ./bin/download-distro.sh
            ./bin/download-distro.sh ${{ matrix.distro }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        id: publish_release
        uses: softprops/action-gh-release@v2
        if: env.SKIP_PUBLISH != 'true' && env.BITRIX_SM_VERSION != ''
        with:
          tag_name: ${{ env.BITRIX_RELEASE_TAG }}
          name: "${{ matrix.distro }} v${{ env.BITRIX_SM_VERSION }}"
          body: |
            ## üì¶ Release Info / –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–ª–∏–∑–µ

            ### English
            This release contains original 1C-Bitrix archives for the edition `${{ matrix.distro }}`.
            Downloaded from official Bitrix servers.

            - **Kernel (main) version:** `${{ env.BITRIX_SM_VERSION }}`
            - **Kernel release date:** `${{ env.BITRIX_SM_VERSION_DATE }}`
            - **Edition (distro):** `${{ matrix.distro }}`

            ### –†—É—Å—Å–∫–∏–π
            –î–∞–Ω–Ω—ã–π —Ä–µ–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∞—Ä—Ö–∏–≤—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ü–∏–∏ `${{ matrix.distro }}` 1C-–ë–∏—Ç—Ä–∏–∫—Å.
            –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –ë–∏—Ç—Ä–∏–∫—Å.

            - **–í–µ—Ä—Å–∏—è —è–¥—Ä–∞ (main):** `${{ env.BITRIX_SM_VERSION }}`
            - **–î–∞—Ç–∞ –≤—ã–ø—É—Å–∫–∞ —è–¥—Ä–∞:** `${{ env.BITRIX_SM_VERSION_DATE }}`
            - **–†–µ–¥–∞–∫—Ü–∏—è (–¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤):** `${{ matrix.distro }}`

            ---
            *Check `manifest.json` for file checksums & module versions.*
          files: |
            ${{ env.BITRIX_OUTPUT_DIR }}/*
          fail_on_unmatched_files: true
          generate_release_notes: false

      - name: Send Telegram Notification
        if: |
          success() &&
          env.SKIP_PUBLISH != 'true' &&
          (github.event.inputs.notify_telegram == 'true' || github.event_name == 'schedule' || github.event.inputs.notify_telegram == null)
        uses: jiacai2050/telegram-action@v1
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          parse-mode: html
          message: |
            üöÄ <b>New Bitrix Release!</b>

            üì¶ <b>Distro:</b> <code>${{ matrix.distro }}</code>
            üè∑ <b>Kernel (main) version:</b> <code>${{ env.BITRIX_SM_VERSION }}</code>
            üìÖ <b>Kernel release date:</b> <code>${{ env.BITRIX_SM_VERSION_DATE }}</code>

            üîó <a href="https://github.com/${{ github.repository }}/releases/tag/${{ env.BITRIX_RELEASE_TAG }}">View on GitHub</a>

            #github #bitrix #release #distro #${{ matrix.distro }}

      - name: Send Telegram Alert on Failure
        if: |
          failure() &&
          (github.event.inputs.notify_telegram == 'true' || github.event_name == 'schedule' || github.event.inputs.notify_telegram == null)
        uses: jiacai2050/telegram-action@v1
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          parse-mode: html
          message: |
            üö® <b>Failed to publish distro!</b>

            üì¶ Distro: <code>${{ matrix.distro }}</code>

            üîó <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">Check Logs</a>

            #github #bitrix #alert #distro #${{ matrix.distro }}
