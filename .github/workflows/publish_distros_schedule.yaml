name: Scheduled publish all distros

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual maintenance'

jobs:
  publish_distro:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        distro: [
          start,
          standard,
          bitrix24,
          bitrix24_shop,
          bitrix24_enterprise,
          small_business,
          business,
          business_cluster,
          business_cluster_postgresql
        ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download distros & create manifest
        id: analysis
        run: |
          chmod +x ./bin/download-distro.sh
          ./bin/download-distro.sh ${{ matrix.distro }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        # –ü—É–±–ª–∏–∫—É–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –∏ –æ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
        if: env.SKIP_PUBLISH != 'true' && env.BITRIX_MAIN_VERSION != '' && env.BITRIX_MAIN_VERSION != 'null'
        with:
          tag_name: ${{ matrix.distro }}-${{ env.BITRIX_MAIN_VERSION }}
          name: "Distro: ${{ matrix.distro }} v${{ env.BITRIX_MAIN_VERSION }}"
          body: |
            ## üì¶ Distribution Information

            This is an automated release of the **1C-Bitrix** distribution. All artifacts are fetched directly from the official source and verified for integrity.

            ### üìù General Metadata
            | Property | Value |
            | :--- | :--- |
            | **Distribution Code** | `${{ matrix.distro }}` |
            | **Kernel Version** | `${{ env.BITRIX_MAIN_VERSION }}` |
            | **Release Date** | `${{ env.BITRIX_MAIN_VERSION_DATE }}` |
            | **Source Build** | Official Bitrix Encoding |

            ### üõ°Ô∏è Integrity Verification
            Each artifact includes checksums (`MD5`, `SHA1`, `SHA256`) as sidecar files. You can verify the integrity of the downloaded files using standard tools:

            ```bash
            # Example: Verify SHA256 for ZIP
            sha256sum -c ${{ matrix.distro }}.zip.sha256
            ```

            ### üöÄ Automation & Integration
            The `manifest.json` file is included for automated systems (like n8n or custom CI/CD). It contains structured data about this release, including file sizes and all checksums.

            ---
            *Generated by Gemini CI/CD Pipeline. [Maintainer notice: Checksums are generated during build time].*
          files: |
            ${{ env.BITRIX_MANIFEST_FILEPATH }}
            ${{ env.BITRIX_META_ZIP_FILEPATH }}
            ${{ env.BITRIX_META_ZIP_FILEPATH }}.*
            ${{ env.BITRIX_META_TAR_FILEPATH }}
            ${{ env.BITRIX_META_TAR_FILEPATH }}.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
