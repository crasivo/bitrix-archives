name: Manual publish any distro

on:
  workflow_dispatch:
    inputs:
      distro_code:
        description: 'Distribution'
        required: true
        default: 'start'
        type: choice
        options: [start,standard,business,small_business,business_cluster,business_cluster_postgresql,bitrix24,bitrix24_shop,bitrix24_enterprise]

jobs:
  publish_distro:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Run analysis and download
        id: analysis
        run: |
          chmod +x ./bin/download-distro.sh
          ./bin/download-distro.sh ${{ github.event.inputs.distro_code }}
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: env.SKIP_PUBLISH != 'true' && env.BITRIX_MAIN_VERSION != ''
        with:
          tag_name: ${{ github.event.inputs.distro_code }}-${{ env.BITRIX_MAIN_VERSION }}
          name: "${{ github.event.inputs.distro_code }} v${{ env.BITRIX_MAIN_VERSION }}"
          body: |
            ## üì¶ Distribution Information

            This is an automated release of the **1C-Bitrix** distribution. All artifacts are fetched directly from the official source and verified for integrity.

            ### üìù General Metadata
            | Property | Value |
            | :--- | :--- |
            | **Distribution Code** | `${{ github.event.inputs.distro_code }}` |
            | **Kernel Version** | `${{ env.BITRIX_MAIN_VERSION }}` |
            | **Release Date** | `${{ env.BITRIX_MAIN_VERSION_DATE }}` |

            ### üõ°Ô∏è Integrity Verification
            Each artifact includes checksums (`MD5`, `SHA1`, `SHA256`) as sidecar files. You can verify the integrity of the downloaded files using standard tools:

            ```bash
            # Example: Verify SHA256
            sha256sum -c ${{ github.event.inputs.distro_code }}_encode.zip.sha256
            ```

            ### üöÄ Automation & Integration
            The `manifest.json` file is included for automated systems (like n8n or custom CI/CD). It contains structured data about this release.
          files: |
            ${{ env.BITRIX_MANIFEST_FILEPATH }}
            ${{ env.BITRIX_META_ZIP_FILEPATH }}
            ${{ env.BITRIX_META_ZIP_FILEPATH }}.*
            ${{ env.BITRIX_META_TAR_FILEPATH }}
            ${{ env.BITRIX_META_TAR_FILEPATH }}.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
