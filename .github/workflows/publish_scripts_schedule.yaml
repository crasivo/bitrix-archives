name: Scheduled Scripts Sync

on:
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      notify_telegram:
        description: 'Send Telegram notifications'
        type: boolean
        default: true

concurrency:
  group: scripts-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish_scripts:
    name: Sync ${{ matrix.script_name }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        script_name: [
          bitrixsetup.php,
          bitrix_server_test.php,
          restore.php
        ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download script & create manifest
        id: download_script
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_on: error
          command: |
            chmod +x ./bin/download-script.sh
            ./bin/download-script.sh ${{ matrix.script_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        id: publish_release
        uses: softprops/action-gh-release@v2
        if: env.SKIP_PUBLISH != 'true'
        with:
          tag_name: ${{ env.BITRIX_RELEASE_TAG }}
          name: "Script: ${{ matrix.script_name }} (${{ github.event.updated_at }})"
          body: |
            ## üì¶ Release Info / –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–ª–∏–∑–µ

            ### [EN]
            Original service script `${{ matrix.script_name }}` from 1C-Bitrix.

            ### [RU]
            –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–ª—É–∂–µ–±–Ω—ã–π —Å–∫—Ä–∏–ø—Ç `${{ matrix.script_name }}` –æ—Ç 1–°-–ë–∏—Ç—Ä–∏–∫—Å.

            ---
            *Check `manifest.json` for file checksums.*
          files: |
            ${{ env.BITRIX_OUTPUT_DIR }}/*

      - name: Send Telegram Notification
        if: |
          success() &&
          env.SKIP_PUBLISH != 'true' &&
          (github.event.inputs.notify_telegram == 'true' || github.event_name == 'schedule' || github.event.inputs.notify_telegram == null)
        uses: jiacai2050/telegram-action@v1
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          parse-mode: html
          message: |
            üõ† <b>Bitrix Script Updated!</b>

            üìÑ <b>File:</b> <code>${{ matrix.script_name }}</code>

            üîó <a href="https://github.com/${{ github.repository }}/releases/tag/${{ env.BITRIX_RELEASE_TAG }}">View on GitHub</a>

            #github #bitrix #release #script #${{ matrix.distro }}

      - name: Send Telegram Alert
        if: |
          failure() &&
          (github.event.inputs.notify_telegram == 'true' || github.event_name == 'schedule' || github.event.inputs.notify_telegram == null)
        uses: jiacai2050/telegram-action@v1
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          parse-mode: html
          message: |
            üö® <b>Failed to publish script!</b>

            üì¶ File: <code>${{ matrix.script_name }}</code>

            üîó <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">Check Logs</a>

            #github #bitrix #alert #script
