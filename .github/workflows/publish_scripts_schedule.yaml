name: Scheduled publish all scripts

on:
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual maintenance'
      notify_telegram:
        description: 'Telegram notifications'
        required: true
        default: true

jobs:
  publish_scripts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        script_name: [
          bitrixsetup.php,
          bitrix_server_test.php,
          restore.php
        ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Define global variables
        run: |
          echo "RELEASE_DATE=$(date +'%d.%m.%Y')" >> $GITHUB_ENV;

      - name: Download script & create manifest
        id: download_script
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_on: error
          command: |
            chmod +x ./bin/download-script.sh
            ./bin/download-script.sh ${{ matrix.script_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        id: publish_release
        uses: softprops/action-gh-release@v2
        if: env.SKIP_PUBLISH != 'true'
        with:
          tag_name: ${{ env.BITRIX_RELEASE_TAG }}
          name: "Script: ${{ matrix.script_name }} (${{ env.RELEASE_DATE }})"
          body: |
            ## üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–ª–∏–∑–µ

            –î–∞–Ω–Ω—ã–π —Ä–µ–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç `${{ matrix.script_name }}` 1C-Bitrix,
            –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ 1–°-–ë–∏—Ç—Ä–∏–∫—Å.

            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ä–µ–ª–∏–∑—É –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ —Ñ–∞–π–ª–µ `manifest.json`.
          files: |
            ${{ env.BITRIX_OUTPUT_DIR }}/*

      - name: Send Telegram Notification
        id: telegram_notification
        uses: jiacai2050/telegram-action@v1
        if: success() && env.SKIP_PUBLISH != 'true' && inputs.notify_telegram != 'false'
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          parse-mode: html
          message: |
            üöÄ <b>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç!</b>

            üì¶ –°–∫—Ä–∏–ø—Ç: <code>${{ matrix.script_name }}</code>

            üîó <a href="https://github.com/${{ github.repository }}/releases/tag/${{ env.BITRIX_RELEASE_TAG }}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–ª–∏–∑</a>

            #github #release #bitrix #script
        env:
          BITRIX_MANIFEST_PATH: ${{ env.BITRIX_MANIFEST_PATH }}
          BITRIX_RELEASE_TAG: ${{ env.BITRIX_RELEASE_TAG }}

      - name: Send Telegram Alert
        id: telegram_alert
        uses: jiacai2050/telegram-action@v1
        if: failure() && inputs.notify_telegram != 'false'
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat-id: ${{ secrets.TELEGRAM_CHAT_ID }}
          parse-mode: html
          message: |
            üö® <b>–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ä–µ–ª–∏–∑–∞</b>

            üì¶ –§–∞–π–ª: <code>${{ matrix.script_name }}</code>

            üîó <a href="https://github.com/${{ github.repository }}/actions">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∂—É—Ä–Ω–∞–ª</a>

            #github #alert #bitrix #script
