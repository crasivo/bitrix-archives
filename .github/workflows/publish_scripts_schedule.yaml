name: Scheduled publish all scripts

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual trigger'
        required: false
        default: 'Manual maintenance'

jobs:
  publish_scripts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        script_name: [
          bitrixsetup.php,
          bitrix_server_test.php,
          restore.php
        ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Define global variables
        run: |
          echo "RELEASE_TAG=${{ matrix.script_name }}-$(date +'%Y%m%d')" >> $GITHUB_ENV;
          echo "RELEASE_DATE=$(date +'%d.%m.%Y')" >> $GITHUB_ENV;
      - name: Download script & create manifest
        id: analysis
        run: |
          ./bin/download-script.sh ${{ matrix.script_name }}
        env:
          GITHUB_RELEASE_DATE: ${{ env.RELEASE_DATE }}
          GITHUB_RELEASE_TAG: ${{ env.RELEASE_TAG }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Script: ${{ matrix.script_name }} (${{ env.RELEASE_DATE }})"
          body: |
            ## üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–ª–∏–∑–µ

            –î–∞–Ω–Ω—ã–π —Ä–µ–ª–∏–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª `${{ matrix.script_name }}`, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞ 1–°-–ë–∏—Ç—Ä–∏–∫—Å.

            **–ú–µ—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
            - –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞: `${{ matrix.script_name }}`
            - MD5: `${{ env.BITRIX_META_SCRIPT_MD5 }}`
            - SHA1: `${{ env.BITRIX_META_SCRIPT_SHA1 }}`
            - SHA256: `${{ env.BITRIX_META_SCRIPT_SHA256 }}`
          files: |
            ${{ env.BITRIX_MANIFEST_PATH }}
            ${{ env.BITRIX_META_SCRIPT_PATH }}
            ${{ env.BITRIX_META_SCRIPT_PATH }}.md5
            ${{ env.BITRIX_META_SCRIPT_PATH }}.sha1
            ${{ env.BITRIX_META_SCRIPT_PATH }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Send Telegram Notification
        if: env.SKIP_PUBLISH != 'true' && env.BITRIX_MAIN_VERSION != ''
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          disable_notification: true
          format: html
          message: |
            üöÄ <b>–ù–æ–≤—ã–π —Ä–µ–ª–∏–∑ —Å–∫—Ä–∏–ø—Ç–∞!</b>

            <b>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</b> <code>${{ matrix.script_name }}</code>

            üîó <a href="https://github.com/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}">View Release</a>

            #github #bitrix #script
